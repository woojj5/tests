# Nginx 리버스 프록시 설정
# keti-ev1.iptime.org로 포트 없이 접근 가능

# Docker 네트워크 내부에서 컨테이너 이름으로 접근
upstream nextjs {
    server jeon-nextjs:3006;
}

upstream fastapi {
    server jeon-api:8000;  # 컨테이너 내부 포트
}

server {
    listen 80;
    server_name keti-ev1.iptime.org;

    # Next.js 웹 애플리케이션
    location / {
        proxy_pass http://nextjs;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # FastAPI 추론 API
    location /api/infer {
        proxy_pass http://fastapi/infer;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # FastAPI 헬스 체크
    location /api/health {
        proxy_pass http://fastapi/health;
        proxy_set_header Host $host;
    }

    # FastAPI 직접 접근 (선택적)
    location /fastapi/ {
        proxy_pass http://fastapi/;
        proxy_set_header Host $host;
        rewrite ^/fastapi/(.*) /$1 break;
    }
}

# 서브도메인 방식 (선택적)
# api.keti-ev1.iptime.org로 FastAPI 접근
server {
    listen 80;
    server_name api.keti-ev1.iptime.org;

    location / {
        proxy_pass http://fastapi;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

